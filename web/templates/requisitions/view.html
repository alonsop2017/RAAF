{% extends "base.html" %}

{% block title %}{{ req.job.title }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Dashboard</a> / <a href="/clients/{{ client_code }}">{{ client_name }}</a> / <span>{{ req_id }}</span>
</div>

<div class="page-header">
    <div class="flex flex-between flex-center">
        <div>
            <h1>{{ req.job.title }}</h1>
            <p class="subtitle">{{ req_id }} | {{ client_name }}</p>
        </div>
        <div class="action-buttons">
            <form action="/requisitions/{{ client_code }}/{{ req_id }}/update-status" method="POST" style="display: inline;" id="statusForm">
                <select name="status" id="statusSelect" class="form-select" style="width: auto;">
                    <option value="active" {% if req.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="on_hold" {% if req.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                    <option value="filled" {% if req.status == 'filled' %}selected{% endif %}>Filled</option>
                    <option value="cancelled" {% if req.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
                <input type="hidden" name="archive_note" id="archiveNote" value="">
            </form>
            <a href="/requisitions/{{ client_code }}/{{ req_id }}/edit" class="btn btn-outline">Edit</a>
        </div>
    </div>
</div>

<!-- Framework alerts -->
{% if request.query_params.get('framework') == 'generated' %}
<div class="alert alert-success">Assessment framework was successfully generated from the job description.</div>
{% elif request.query_params.get('framework') == 'regenerated' %}
<div class="alert alert-success">Assessment framework was successfully regenerated from the job description.</div>
{% elif request.query_params.get('framework') == 'extraction_failed' %}
<div class="alert alert-warning">
    <strong>Warning:</strong> Could not extract text from the uploaded job description. A generic template was used instead.
    <form action="/requisitions/{{ client_code }}/{{ req_id }}/regenerate-framework" method="POST" style="display:inline; margin-left: 0.5rem;">
        <button type="submit" class="btn btn-sm btn-primary">Retry Framework Generation</button>
    </form>
</div>
{% elif request.query_params.get('framework') == 'generation_failed' %}
<div class="alert alert-warning">
    <strong>Warning:</strong> AI framework generation failed. A generic template was used instead.
    <form action="/requisitions/{{ client_code }}/{{ req_id }}/regenerate-framework" method="POST" style="display:inline; margin-left: 0.5rem;">
        <button type="submit" class="btn btn-sm btn-primary">Retry Framework Generation</button>
    </form>
</div>
{% endif %}

{% if request.query_params.get('jd') == 'updated' %}
<div class="alert alert-success">Job description has been updated successfully.</div>
{% elif request.query_params.get('jd') == 'empty' %}
<div class="alert alert-warning">The uploaded file was empty. Job description was not updated.</div>
{% endif %}

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ candidate_count }}</div>
        <div class="stat-label">Total Candidates</div>
    </div>
    <div class="stat-card success">
        <div class="stat-value">{{ assessed_count }}</div>
        <div class="stat-label">Assessed</div>
    </div>
    <div class="stat-card info">
        <div class="stat-value">{{ candidate_count - assessed_count }}</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ reports|length }}</div>
        <div class="stat-label">Reports</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h3>Quick Actions</h3>
    </div>
    <div class="card-body">
        <div class="action-buttons">
            <a href="/candidates/{{ client_code }}/{{ req_id }}/upload" class="btn btn-primary">Upload Resumes</a>
            <a href="/assessments/{{ client_code }}/{{ req_id }}" class="btn btn-primary">Assess Candidates</a>
            <a href="/reports/{{ client_code }}/{{ req_id }}" class="btn btn-primary">Generate Report</a>
            <a href="/pcr/sync/{{ client_code }}/{{ req_id }}" class="btn btn-outline">PCR Sync</a>
        </div>
    </div>
</div>

<div class="two-column">
    <div>
        <!-- Candidates -->
        <div class="card">
            <div class="card-header">
                <h3>Candidates</h3>
                <a href="/candidates/{{ client_code }}/{{ req_id }}" class="btn btn-sm btn-outline">View All</a>
            </div>
            {% if candidates %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Candidate</th>
                            <th>Score</th>
                            <th>Recommendation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidate in candidates[:10] %}
                        <tr>
                            <td>
                                <a href="/candidates/{{ client_code }}/{{ req_id }}/{{ candidate.name_normalized }}"
                                   style="font-weight: 500; color: var(--primary-color); text-decoration: none;">
                                    {{ candidate.name }}
                                </a>
                            </td>
                            <td>
                                {% if candidate.assessed %}
                                <span class="score-display">{{ candidate.score }}/100</span>
                                <span class="score-percentage">({{ candidate.percentage }}%)</span>
                                {% else %}
                                <span class="text-muted">Not assessed</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if candidate.assessed %}
                                    {% if candidate.recommendation == 'STRONG RECOMMEND' %}
                                    <span class="badge rec-strong">{{ candidate.recommendation }}</span>
                                    {% elif candidate.recommendation == 'RECOMMEND' %}
                                    <span class="badge rec-recommend">{{ candidate.recommendation }}</span>
                                    {% elif candidate.recommendation == 'CONDITIONAL' %}
                                    <span class="badge rec-conditional">{{ candidate.recommendation }}</span>
                                    {% elif candidate.recommendation == 'DO NOT RECOMMEND' %}
                                    <span class="badge rec-dnr">DNR</span>
                                    {% else %}
                                    <span class="badge rec-pending">{{ candidate.recommendation }}</span>
                                    {% endif %}
                                {% else %}
                                <span class="badge rec-pending">PENDING</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/candidates/{{ client_code }}/{{ req_id }}/{{ candidate.name_normalized }}"
                                   class="btn btn-sm btn-outline">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if candidates|length > 10 %}
            <div class="card-body text-center">
                <a href="/candidates/{{ client_code }}/{{ req_id }}" class="btn btn-outline">View All {{ candidates|length }} Candidates</a>
            </div>
            {% endif %}
            {% else %}
            <div class="card-body">
                <div class="empty-state">
                    <h3>No Candidates Yet</h3>
                    <p>Upload resumes or sync from PCR to add candidates.</p>
                    <div class="action-buttons mt-2" style="justify-content: center;">
                        <a href="/candidates/{{ client_code }}/{{ req_id }}/upload" class="btn btn-primary">Upload Resumes</a>
                        <a href="/pcr/sync/{{ client_code }}/{{ req_id }}" class="btn btn-outline">Sync from PCR</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Reports -->
        {% if reports %}
        <div class="card">
            <div class="card-header">
                <h3>Recent Reports</h3>
                <a href="/reports/{{ client_code }}/{{ req_id }}" class="btn btn-sm btn-outline">All Reports</a>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Report</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports[:5] %}
                        <tr>
                            <td>{{ report.filename }}</td>
                            <td>{{ report.created }}</td>
                            <td>
                                <a href="/reports/{{ client_code }}/{{ req_id }}/download/final/{{ report.filename }}"
                                   class="btn btn-sm btn-outline">Download</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <div>
        <!-- Job Details -->
        <div class="card">
            <div class="card-header">
                <h3>Job Details</h3>
            </div>
            <div class="card-body">
                <p><strong>Title:</strong> {{ req.job.title }}</p>
                <p class="mt-1"><strong>Department:</strong> {{ req.job.department or 'N/A' }}</p>
                <p class="mt-1"><strong>Location:</strong> {{ req.job.location or 'N/A' }}</p>

                {% if req.job.salary_range %}
                <p class="mt-1"><strong>Salary Range:</strong>
                    {% if req.job.salary_range.min and req.job.salary_range.max %}
                    ${{ "{:,}".format(req.job.salary_range.min) }} - ${{ "{:,}".format(req.job.salary_range.max) }} {{ req.job.salary_range.currency or 'CAD' }}
                    {% else %}
                    N/A
                    {% endif %}
                </p>
                {% endif %}

                <h4 class="mt-3 mb-1">Requirements</h4>
                <p><strong>Experience:</strong> {{ req.requirements.experience_years_min or 0 }}+ years</p>
                <p class="mt-1"><strong>Education:</strong> {{ req.requirements.education or 'N/A' }}</p>

                <h4 class="mt-3 mb-1">Assessment Thresholds</h4>
                <p><strong>Strong Recommend:</strong> {{ req.assessment.thresholds.strong_recommend }}%+</p>
                <p class="mt-1"><strong>Recommend:</strong> {{ req.assessment.thresholds.recommend }}%+</p>
                <p class="mt-1"><strong>Conditional:</strong> {{ req.assessment.thresholds.conditional }}%+</p>

                {% if req.notes %}
                <h4 class="mt-3 mb-1">Notes</h4>
                <p style="white-space: pre-wrap;">{{ req.notes }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Job Description -->
        <div class="card">
            <div class="card-header">
                <h3>Job Description</h3>
            </div>
            <div class="card-body">
                {% if has_job_description %}
                <p><strong>File:</strong> {{ jd_filename }}</p>
                <div class="action-buttons mt-2">
                    <a href="/requisitions/{{ client_code }}/{{ req_id }}/download-jd" class="btn btn-sm btn-primary">Download</a>
                </div>
                <hr style="margin: 1rem 0; border-color: var(--border-color);">
                <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">Replace job description:</p>
                <form action="/requisitions/{{ client_code }}/{{ req_id }}/update-jd" method="POST" enctype="multipart/form-data">
                    <div class="form-group" style="margin-bottom: 0.5rem;">
                        <input type="file" name="job_description" class="form-input" accept=".pdf,.docx" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-outline">Upload & Replace</button>
                </form>
                {% else %}
                <div class="empty-state" style="padding: 1rem 0;">
                    <p class="text-muted">No job description uploaded.</p>
                    <form action="/requisitions/{{ client_code }}/{{ req_id }}/update-jd" method="POST" enctype="multipart/form-data" class="mt-2">
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                            <input type="file" name="job_description" class="form-input" accept=".pdf,.docx" required>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">Upload Job Description</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- PCR Integration -->
        <div class="card">
            <div class="card-header">
                <h3>PCR Integration</h3>
            </div>
            <div class="card-body">
                {% set positions = pcr_integration.get('positions', []) if pcr_integration else [] %}
                {% if pcr_integration and (pcr_integration.job_id or pcr_integration.get('positions', [])) %}
                <!-- Linked positions -->
                <div class="pcr-linked">
                    {% if positions %}
                    <table style="width:100%; font-size:0.85rem; border-collapse:collapse;" class="mb-2">
                        <thead>
                            <tr style="border-bottom:1px solid var(--border-color);">
                                <th style="text-align:left; padding:0.3rem 0.5rem;">Position</th>
                                <th style="text-align:left; padding:0.3rem 0.5rem;">Company</th>
                                <th style="text-align:left; padding:0.3rem 0.5rem;">Job ID</th>
                                <th style="padding:0.3rem 0.5rem;"></th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for pos in positions %}
                            <tr style="border-bottom:1px solid var(--border-color);">
                                <td style="padding:0.3rem 0.5rem;">{{ pos.job_title or 'N/A' }}</td>
                                <td style="padding:0.3rem 0.5rem;">{{ pos.company_name or 'N/A' }}</td>
                                <td style="padding:0.3rem 0.5rem;">{{ pos.job_id }}</td>
                                <td style="padding:0.3rem 0.5rem; text-align:right;">
                                    <form action="/requisitions/{{ client_code }}/{{ req_id }}/unlink-pcr" method="POST" style="display:inline;">
                                        <input type="hidden" name="job_id" value="{{ pos.job_id }}">
                                        <button type="submit" class="btn btn-sm btn-outline" style="padding:0.1rem 0.4rem; font-size:0.75rem;" onclick="return confirm('Unlink position {{ pos.job_id }}?')">Remove</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p><strong>Job ID:</strong> {{ pcr_integration.job_id }}</p>
                    {% endif %}
                    <p class="mt-1"><strong>Last Sync:</strong> <span id="lastSyncTime">{{ pcr_integration.last_sync or 'Never' }}</span></p>
                    <p class="mt-1 text-muted" style="font-size: 0.8rem;">Auto-sync runs every hour</p>
                    <div class="action-buttons mt-2">
                        <a href="/pcr/sync/{{ client_code }}/{{ req_id }}" class="btn btn-sm btn-primary">Sync Candidates</a>
                        <form action="/requisitions/{{ client_code }}/{{ req_id }}/unlink-pcr" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-outline" onclick="return confirm('Unlink ALL PCR positions?')">Unlink All</button>
                        </form>
                    </div>
                </div>
                {% endif %}

                <!-- Search and link (always shown so more positions can be added) -->
                <div class="pcr-search {% if pcr_integration and (pcr_integration.job_id or pcr_integration.get('positions', [])) %}mt-2{% endif %}">
                    {% if pcr_integration and (pcr_integration.job_id or pcr_integration.get('positions', [])) %}
                    <hr style="border-color:var(--border-color); margin:0.5rem 0;">
                    <p class="text-muted" style="font-size:0.8rem; margin-bottom:0.5rem;">Link additional positions:</p>
                    {% endif %}
                    <div class="form-group">
                        <label class="form-label" for="pcrSearch">Search PCR Positions</label>
                        <div style="display:flex; gap:0.5rem;">
                            <input type="text" id="pcrSearch" class="form-input" style="flex:1;" placeholder="Company name..." value="{{ pcr_company_name }}">
                            <button type="button" id="pcrSearchBtn" class="btn btn-sm btn-primary">Search</button>
                        </div>
                    </div>
                    <div id="pcrResults" style="display:none;" class="mt-2">
                        <div class="form-group">
                            <label class="form-label">Select Positions</label>
                            <div id="pcrCheckboxList" style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:4px; padding:0.5rem; font-size:0.85rem;"></div>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary mt-1" id="pcrLinkBtn" disabled>Link Selected</button>
                    </div>
                    <div id="pcrLoading" style="display:none;" class="mt-2">
                        <span class="text-muted">Searching PCR positions (this may take a few seconds)...</span>
                    </div>
                    <div id="pcrError" style="display:none;" class="mt-2">
                        <span style="color:var(--danger-color);"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- PCR Sync Log -->
        {% if pcr_integration and (pcr_integration.job_id or pcr_integration.get('positions', [])) %}
        <div class="card">
            <div class="card-header">
                <h3>Sync Log</h3>
                <button type="button" id="refreshLogBtn" class="btn btn-sm btn-outline">Refresh</button>
            </div>
            <div class="card-body">
                <div id="syncLogContent" style="max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 0.78rem; line-height: 1.5; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                    <span class="text-muted">Loading sync log...</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Batches -->
        {% if batches %}
        <div class="card">
            <div class="card-header">
                <h3>Assessment Batches</h3>
            </div>
            <div class="card-body">
                {% for batch in batches %}
                <div class="flex flex-between flex-center mb-1">
                    <span>{{ batch.name }}</span>
                    <span class="badge badge-secondary">{{ batch.candidate_count }} candidates</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelModal" class="modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cancel and Archive Requisition?</h3>
        </div>
        <div class="modal-body">
            <p><strong>Warning:</strong> Cancelling this requisition will:</p>
            <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                <li>Move all requisition data to the archive folder</li>
                <li>Remove it from the active requisitions list</li>
                <li>This action cannot be easily undone</li>
            </ul>
            <div class="form-group">
                <label class="form-label" for="cancelReason">Reason for cancellation (optional):</label>
                <textarea class="form-textarea" id="cancelReason" rows="2" placeholder="e.g., Client paused hiring, Position filled externally..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" id="cancelModalClose">Keep Active</button>
            <button type="button" class="btn btn-danger" id="confirmCancel">Cancel & Archive</button>
        </div>
    </div>
</div>

<script>
(function() {
    const statusSelect = document.getElementById('statusSelect');
    const statusForm = document.getElementById('statusForm');
    const cancelModal = document.getElementById('cancelModal');
    const cancelReason = document.getElementById('cancelReason');
    const archiveNote = document.getElementById('archiveNote');
    const confirmCancel = document.getElementById('confirmCancel');
    const cancelModalClose = document.getElementById('cancelModalClose');

    let previousStatus = statusSelect.value;

    statusSelect.addEventListener('change', function() {
        if (this.value === 'cancelled') {
            // Show confirmation modal
            cancelModal.style.display = 'flex';
        } else {
            // Submit form for other status changes
            statusForm.submit();
        }
    });

    cancelModalClose.addEventListener('click', function() {
        // Reset to previous status and close modal
        statusSelect.value = previousStatus;
        cancelModal.style.display = 'none';
        cancelReason.value = '';
    });

    confirmCancel.addEventListener('click', function() {
        // Set the archive note and submit
        archiveNote.value = cancelReason.value;
        statusForm.submit();
    });

    // Close modal on overlay click
    cancelModal.querySelector('.modal-overlay').addEventListener('click', function() {
        statusSelect.value = previousStatus;
        cancelModal.style.display = 'none';
        cancelReason.value = '';
    });

    // PCR position search and link
    var pcrSearchBtn = document.getElementById('pcrSearchBtn');
    if (pcrSearchBtn) {
        var pcrSearchInput = document.getElementById('pcrSearch');
        var pcrResults = document.getElementById('pcrResults');
        var pcrCheckboxList = document.getElementById('pcrCheckboxList');
        var pcrLoading = document.getElementById('pcrLoading');
        var pcrError = document.getElementById('pcrError');
        var pcrLinkBtn = document.getElementById('pcrLinkBtn');
        var positionsData = [];

        // IDs already linked (to mark them in the list)
        var linkedIds = new Set();
        {% if pcr_integration and pcr_integration.get('positions') %}
        {% for pos in pcr_integration.positions %}
        linkedIds.add('{{ pos.job_id }}');
        {% endfor %}
        {% elif pcr_integration and pcr_integration.job_id %}
        linkedIds.add('{{ pcr_integration.job_id }}');
        {% endif %}

        function updateLinkBtn() {
            var checked = pcrCheckboxList.querySelectorAll('input[type=checkbox]:checked');
            pcrLinkBtn.disabled = (checked.length === 0);
            pcrLinkBtn.textContent = checked.length > 0
                ? 'Link Selected (' + checked.length + ')'
                : 'Link Selected';
        }

        pcrSearchBtn.addEventListener('click', function() {
            var query = pcrSearchInput.value.trim();
            if (!query) return;
            pcrLoading.style.display = 'block';
            pcrResults.style.display = 'none';
            pcrError.style.display = 'none';
            pcrSearchBtn.disabled = true;
            pcrSearchBtn.textContent = 'Searching...';

            fetch('/pcr/api/positions?search=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    pcrLoading.style.display = 'none';
                    pcrSearchBtn.disabled = false;
                    pcrSearchBtn.textContent = 'Search';
                    if (data.error) {
                        pcrError.querySelector('span').textContent = data.error;
                        pcrError.style.display = 'block';
                        return;
                    }
                    positionsData = data;
                    pcrCheckboxList.innerHTML = '';
                    if (data.length === 0) {
                        pcrCheckboxList.innerHTML = '<span class="text-muted">No positions found.</span>';
                        pcrResults.style.display = 'block';
                        pcrLinkBtn.disabled = true;
                        return;
                    }
                    var heading = document.createElement('div');
                    heading.style.cssText = 'font-size:0.8rem; color:var(--text-muted); margin-bottom:0.4rem;';
                    heading.textContent = data.length + ' position(s) found:';
                    pcrCheckboxList.appendChild(heading);

                    data.forEach(function(pos) {
                        var already = linkedIds.has(String(pos.job_id));
                        var row = document.createElement('label');
                        row.style.cssText = 'display:flex; align-items:flex-start; gap:0.5rem; padding:0.35rem 0.25rem; border-bottom:1px solid var(--border-color); cursor:pointer;' + (already ? 'opacity:0.5;' : '');
                        var cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.value = pos.job_id;
                        cb.dataset.title = pos.title;
                        cb.dataset.company = pos.company;
                        cb.style.marginTop = '0.2rem';
                        if (already) { cb.disabled = true; }
                        cb.addEventListener('change', updateLinkBtn);
                        var text = document.createElement('span');
                        text.innerHTML = '<code style="font-size:0.75rem; background:var(--bg-color); border:1px solid var(--border-color); padding:0.1rem 0.35rem; border-radius:3px; margin-right:0.4rem; color:var(--primary-color);">' + escapeHtml(String(pos.job_id)) + '</code>' +
                            '<strong>' + escapeHtml(pos.title) + '</strong>' +
                            (already ? ' <em style="font-size:0.8rem;">(already linked)</em>' : '') +
                            '<br><span style="font-size:0.8rem; color:var(--text-muted);">' + escapeHtml(pos.company) +
                            ' &middot; ' + escapeHtml(pos.location || '') +
                            ' &middot; ' + escapeHtml(pos.status || '') +
                            '</span>';
                        row.appendChild(cb);
                        row.appendChild(text);
                        pcrCheckboxList.appendChild(row);
                    });
                    pcrResults.style.display = 'block';
                    pcrLinkBtn.disabled = true;
                })
                .catch(function(err) {
                    pcrLoading.style.display = 'none';
                    pcrSearchBtn.disabled = false;
                    pcrSearchBtn.textContent = 'Search';
                    pcrError.querySelector('span').textContent = 'Failed to fetch positions: ' + err;
                    pcrError.style.display = 'block';
                });
        });

        // Link selected positions one by one via fetch
        pcrLinkBtn.addEventListener('click', function() {
            var checked = pcrCheckboxList.querySelectorAll('input[type=checkbox]:checked');
            if (checked.length === 0) return;
            pcrLinkBtn.disabled = true;
            pcrLinkBtn.textContent = 'Linking...';

            var promises = [];
            checked.forEach(function(cb) {
                var body = new URLSearchParams();
                body.append('job_id', cb.value);
                body.append('job_title', cb.dataset.title || '');
                body.append('company_name', cb.dataset.company || '');
                promises.push(
                    fetch('/requisitions/{{ client_code }}/{{ req_id }}/link-pcr', {
                        method: 'POST',
                        body: body,
                        redirect: 'manual'
                    })
                );
            });

            Promise.all(promises).then(function() {
                window.location.reload();
            }).catch(function() {
                window.location.reload();
            });
        });

        pcrSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                pcrSearchBtn.click();
            }
        });

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    // PCR Sync Log viewer
    var syncLogContent = document.getElementById('syncLogContent');
    var refreshLogBtn = document.getElementById('refreshLogBtn');
    if (syncLogContent) {
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatLogLine(line) {
            var escaped = escapeHtml(line);
            if (escaped.indexOf('ERROR:') !== -1 || escaped.indexOf('failed') !== -1) {
                return '<span style="color:var(--danger-color);">' + escaped + '</span>';
            }
            if (escaped.indexOf('OK:') !== -1 || escaped.indexOf('SUCCESS') !== -1) {
                return '<span style="color:var(--success-color);">' + escaped + '</span>';
            }
            if (escaped.indexOf('SKIP:') !== -1) {
                return '<span style="color:var(--warning-color);">' + escaped + '</span>';
            }
            if (escaped.indexOf('new applicant') !== -1) {
                return '<span style="color:var(--primary-color); font-weight:600;">' + escaped + '</span>';
            }
            if (escaped.indexOf('==========') !== -1) {
                return '<span style="color:var(--text-muted);">' + escaped + '</span>';
            }
            return escaped;
        }

        function loadSyncLog() {
            fetch('/requisitions/{{ client_code }}/{{ req_id }}/sync-log?lines=30')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.lines && data.lines.length > 0) {
                        syncLogContent.innerHTML = data.lines.map(formatLogLine).join('\n');
                        syncLogContent.scrollTop = syncLogContent.scrollHeight;
                    } else {
                        syncLogContent.innerHTML = '<span class="text-muted">No sync activity recorded yet.</span>';
                    }
                    if (data.last_sync) {
                        var el = document.getElementById('lastSyncTime');
                        if (el) el.textContent = data.last_sync;
                    }
                })
                .catch(function() {
                    syncLogContent.innerHTML = '<span class="text-muted">Could not load sync log.</span>';
                });
        }

        loadSyncLog();
        refreshLogBtn.addEventListener('click', loadSyncLog);
        // Auto-refresh every 60 seconds
        setInterval(loadSyncLog, 60000);
    }
})();
</script>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}
.modal-content {
    position: relative;
    background: var(--card-bg);
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}
.modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
}
.modal-header h3 {
    margin: 0;
    color: var(--danger-color);
}
.modal-body {
    padding: 1.5rem;
}
.modal-body p {
    margin: 0;
}
.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}
.btn-danger {
    background-color: var(--danger-color);
    color: white;
    border: none;
}
.btn-danger:hover {
    background-color: #dc2626;
}
</style>
{% endblock %}
