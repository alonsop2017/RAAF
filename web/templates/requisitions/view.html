{% extends "base.html" %}

{% block title %}{{ req.job.title }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Dashboard</a> / <a href="/clients/{{ client_code }}">{{ client_name }}</a> / <span>{{ req_id }}</span>
</div>

<div class="page-header">
    <div class="flex flex-between flex-center">
        <div>
            <h1>{{ req.job.title }}</h1>
            <p class="subtitle">{{ req_id }} | {{ client_name }}</p>
        </div>
        <div class="action-buttons">
            <form action="/requisitions/{{ client_code }}/{{ req_id }}/update-status" method="POST" style="display: inline;" id="statusForm">
                <select name="status" id="statusSelect" class="form-select" style="width: auto;">
                    <option value="active" {% if req.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="on_hold" {% if req.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                    <option value="filled" {% if req.status == 'filled' %}selected{% endif %}>Filled</option>
                    <option value="cancelled" {% if req.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
                <input type="hidden" name="archive_note" id="archiveNote" value="">
            </form>
            <a href="/requisitions/{{ client_code }}/{{ req_id }}/edit" class="btn btn-outline">Edit</a>
        </div>
    </div>
</div>

<!-- Framework alerts -->
{% if request.query_params.get('framework') == 'generated' %}
<div class="alert alert-success">Assessment framework was successfully generated from the job description.</div>
{% elif request.query_params.get('framework') == 'regenerated' %}
<div class="alert alert-success">Assessment framework was successfully regenerated from the job description.</div>
{% elif request.query_params.get('framework') == 'extraction_failed' %}
<div class="alert alert-warning">
    <strong>Warning:</strong> Could not extract text from the uploaded job description. A generic template was used instead.
    <form action="/requisitions/{{ client_code }}/{{ req_id }}/regenerate-framework" method="POST" style="display:inline; margin-left: 0.5rem;">
        <button type="submit" class="btn btn-sm btn-primary">Retry Framework Generation</button>
    </form>
</div>
{% elif request.query_params.get('framework') == 'generation_failed' %}
<div class="alert alert-warning">
    <strong>Warning:</strong> AI framework generation failed. A generic template was used instead.
    <form action="/requisitions/{{ client_code }}/{{ req_id }}/regenerate-framework" method="POST" style="display:inline; margin-left: 0.5rem;">
        <button type="submit" class="btn btn-sm btn-primary">Retry Framework Generation</button>
    </form>
</div>
{% endif %}

{% if request.query_params.get('jd') == 'updated' %}
<div class="alert alert-success">Job description has been updated successfully.</div>
{% elif request.query_params.get('jd') == 'empty' %}
<div class="alert alert-warning">The uploaded file was empty. Job description was not updated.</div>
{% endif %}

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ candidate_count }}</div>
        <div class="stat-label">Total Candidates</div>
    </div>
    <div class="stat-card success">
        <div class="stat-value">{{ assessed_count }}</div>
        <div class="stat-label">Assessed</div>
    </div>
    <div class="stat-card info">
        <div class="stat-value">{{ candidate_count - assessed_count }}</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ reports|length }}</div>
        <div class="stat-label">Reports</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h3>Quick Actions</h3>
    </div>
    <div class="card-body">
        <div class="action-buttons">
            <a href="/candidates/{{ client_code }}/{{ req_id }}/upload" class="btn btn-primary">Upload Resumes</a>
            <a href="/assessments/{{ client_code }}/{{ req_id }}" class="btn btn-primary">Assess Candidates</a>
            <a href="/reports/{{ client_code }}/{{ req_id }}" class="btn btn-primary">Generate Report</a>
            <a href="/pcr/sync/{{ client_code }}/{{ req_id }}" class="btn btn-outline">PCR Sync</a>
        </div>
    </div>
</div>

<div class="two-column">
    <div>
        <!-- Candidates -->
        <div class="card">
            <div class="card-header">
                <h3>Candidates</h3>
                <a href="/candidates/{{ client_code }}/{{ req_id }}" class="btn btn-sm btn-outline">View All</a>
            </div>
            {% if candidates %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Candidate</th>
                            <th>Score</th>
                            <th>Recommendation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidate in candidates[:10] %}
                        <tr>
                            <td>
                                <a href="/candidates/{{ client_code }}/{{ req_id }}/{{ candidate.name_normalized }}"
                                   style="font-weight: 500; color: var(--primary-color); text-decoration: none;">
                                    {{ candidate.name }}
                                </a>
                            </td>
                            <td>
                                {% if candidate.assessed %}
                                <span class="score-display">{{ candidate.score }}/100</span>
                                <span class="score-percentage">({{ candidate.percentage }}%)</span>
                                {% else %}
                                <span class="text-muted">Not assessed</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if candidate.assessed %}
                                    {% if candidate.recommendation == 'STRONG RECOMMEND' %}
                                    <span class="badge rec-strong">{{ candidate.recommendation }}</span>
                                    {% elif candidate.recommendation == 'RECOMMEND' %}
                                    <span class="badge rec-recommend">{{ candidate.recommendation }}</span>
                                    {% elif candidate.recommendation == 'CONDITIONAL' %}
                                    <span class="badge rec-conditional">{{ candidate.recommendation }}</span>
                                    {% elif candidate.recommendation == 'DO NOT RECOMMEND' %}
                                    <span class="badge rec-dnr">DNR</span>
                                    {% else %}
                                    <span class="badge rec-pending">{{ candidate.recommendation }}</span>
                                    {% endif %}
                                {% else %}
                                <span class="badge rec-pending">PENDING</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/candidates/{{ client_code }}/{{ req_id }}/{{ candidate.name_normalized }}"
                                   class="btn btn-sm btn-outline">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if candidates|length > 10 %}
            <div class="card-body text-center">
                <a href="/candidates/{{ client_code }}/{{ req_id }}" class="btn btn-outline">View All {{ candidates|length }} Candidates</a>
            </div>
            {% endif %}
            {% else %}
            <div class="card-body">
                <div class="empty-state">
                    <h3>No Candidates Yet</h3>
                    <p>Upload resumes or sync from PCR to add candidates.</p>
                    <div class="action-buttons mt-2" style="justify-content: center;">
                        <a href="/candidates/{{ client_code }}/{{ req_id }}/upload" class="btn btn-primary">Upload Resumes</a>
                        <a href="/pcr/sync/{{ client_code }}/{{ req_id }}" class="btn btn-outline">Sync from PCR</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Reports -->
        {% if reports %}
        <div class="card">
            <div class="card-header">
                <h3>Recent Reports</h3>
                <a href="/reports/{{ client_code }}/{{ req_id }}" class="btn btn-sm btn-outline">All Reports</a>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Report</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports[:5] %}
                        <tr>
                            <td>{{ report.filename }}</td>
                            <td>{{ report.created }}</td>
                            <td>
                                <a href="/reports/{{ client_code }}/{{ req_id }}/download/final/{{ report.filename }}"
                                   class="btn btn-sm btn-outline">Download</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <div>
        <!-- Job Details -->
        <div class="card">
            <div class="card-header">
                <h3>Job Details</h3>
            </div>
            <div class="card-body">
                <p><strong>Title:</strong> {{ req.job.title }}</p>
                <p class="mt-1"><strong>Department:</strong> {{ req.job.department or 'N/A' }}</p>
                <p class="mt-1"><strong>Location:</strong> {{ req.job.location or 'N/A' }}</p>

                {% if req.job.salary_range %}
                <p class="mt-1"><strong>Salary Range:</strong>
                    {% if req.job.salary_range.min and req.job.salary_range.max %}
                    ${{ "{:,}".format(req.job.salary_range.min) }} - ${{ "{:,}".format(req.job.salary_range.max) }} {{ req.job.salary_range.currency or 'CAD' }}
                    {% else %}
                    N/A
                    {% endif %}
                </p>
                {% endif %}

                <h4 class="mt-3 mb-1">Requirements</h4>
                <p><strong>Experience:</strong> {{ req.requirements.experience_years_min or 0 }}+ years</p>
                <p class="mt-1"><strong>Education:</strong> {{ req.requirements.education or 'N/A' }}</p>

                <h4 class="mt-3 mb-1">Assessment Thresholds</h4>
                <p><strong>Strong Recommend:</strong> {{ req.assessment.thresholds.strong_recommend }}%+</p>
                <p class="mt-1"><strong>Recommend:</strong> {{ req.assessment.thresholds.recommend }}%+</p>
                <p class="mt-1"><strong>Conditional:</strong> {{ req.assessment.thresholds.conditional }}%+</p>

                {% if req.notes %}
                <h4 class="mt-3 mb-1">Notes</h4>
                <p style="white-space: pre-wrap;">{{ req.notes }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Job Description -->
        <div class="card">
            <div class="card-header">
                <h3>Job Description</h3>
            </div>
            <div class="card-body">
                {% if has_job_description %}
                <p><strong>File:</strong> {{ jd_filename }}</p>
                <div class="action-buttons mt-2">
                    <a href="/requisitions/{{ client_code }}/{{ req_id }}/download-jd" class="btn btn-sm btn-primary">Download</a>
                </div>
                <hr style="margin: 1rem 0; border-color: var(--border-color);">
                <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">Replace job description:</p>
                <form action="/requisitions/{{ client_code }}/{{ req_id }}/update-jd" method="POST" enctype="multipart/form-data">
                    <div class="form-group" style="margin-bottom: 0.5rem;">
                        <input type="file" name="job_description" class="form-input" accept=".pdf,.docx" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-outline">Upload & Replace</button>
                </form>
                {% else %}
                <div class="empty-state" style="padding: 1rem 0;">
                    <p class="text-muted">No job description uploaded.</p>
                    <form action="/requisitions/{{ client_code }}/{{ req_id }}/update-jd" method="POST" enctype="multipart/form-data" class="mt-2">
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                            <input type="file" name="job_description" class="form-input" accept=".pdf,.docx" required>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">Upload Job Description</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- PCR Integration -->
        <div class="card">
            <div class="card-header">
                <h3>PCR Integration</h3>
            </div>
            <div class="card-body">
                {% if pcr_integration and pcr_integration.job_id %}
                <!-- Linked state -->
                <div class="pcr-linked">
                    <p><strong>Position:</strong> {{ pcr_integration.job_title or 'N/A' }}</p>
                    <p class="mt-1"><strong>Company:</strong> {{ pcr_integration.company_name or 'N/A' }}</p>
                    <p class="mt-1"><strong>Job ID:</strong> {{ pcr_integration.job_id }}</p>
                    <p class="mt-1"><strong>Linked:</strong> {{ pcr_integration.linked_date or 'N/A' }}</p>
                    <div class="action-buttons mt-2">
                        <a href="/pcr/sync/{{ client_code }}/{{ req_id }}" class="btn btn-sm btn-primary">Sync Candidates</a>
                        <form action="/requisitions/{{ client_code }}/{{ req_id }}/unlink-pcr" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-outline" onclick="return confirm('Unlink this PCR position?')">Unlink</button>
                        </form>
                    </div>
                </div>
                {% else %}
                <!-- Not linked â€” search and link -->
                <div class="pcr-search">
                    <div class="form-group">
                        <label class="form-label" for="pcrSearch">Search PCR Positions</label>
                        <div style="display:flex; gap:0.5rem;">
                            <input type="text" id="pcrSearch" class="form-input" style="flex:1;" placeholder="Company name..." value="{{ pcr_company_name }}">
                            <button type="button" id="pcrSearchBtn" class="btn btn-sm btn-primary">Search</button>
                        </div>
                    </div>
                    <div id="pcrResults" style="display:none;" class="mt-2">
                        <div class="form-group">
                            <label class="form-label" for="pcrSelect">Select Position</label>
                            <select id="pcrSelect" class="form-select">
                                <option value="">-- Select a position --</option>
                            </select>
                        </div>
                        <form action="/requisitions/{{ client_code }}/{{ req_id }}/link-pcr" method="POST" id="pcrLinkForm" class="mt-1">
                            <input type="hidden" name="job_id" id="pcrJobId">
                            <input type="hidden" name="job_title" id="pcrJobTitle">
                            <input type="hidden" name="company_name" id="pcrCompanyName">
                            <button type="submit" class="btn btn-sm btn-primary" id="pcrLinkBtn" disabled>Link Position</button>
                        </form>
                    </div>
                    <div id="pcrLoading" style="display:none;" class="mt-2">
                        <span class="text-muted">Searching...</span>
                    </div>
                    <div id="pcrError" style="display:none;" class="mt-2">
                        <span style="color:var(--danger-color);"></span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Batches -->
        {% if batches %}
        <div class="card">
            <div class="card-header">
                <h3>Assessment Batches</h3>
            </div>
            <div class="card-body">
                {% for batch in batches %}
                <div class="flex flex-between flex-center mb-1">
                    <span>{{ batch.name }}</span>
                    <span class="badge badge-secondary">{{ batch.candidate_count }} candidates</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelModal" class="modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cancel and Archive Requisition?</h3>
        </div>
        <div class="modal-body">
            <p><strong>Warning:</strong> Cancelling this requisition will:</p>
            <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                <li>Move all requisition data to the archive folder</li>
                <li>Remove it from the active requisitions list</li>
                <li>This action cannot be easily undone</li>
            </ul>
            <div class="form-group">
                <label class="form-label" for="cancelReason">Reason for cancellation (optional):</label>
                <textarea class="form-textarea" id="cancelReason" rows="2" placeholder="e.g., Client paused hiring, Position filled externally..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" id="cancelModalClose">Keep Active</button>
            <button type="button" class="btn btn-danger" id="confirmCancel">Cancel & Archive</button>
        </div>
    </div>
</div>

<script>
(function() {
    const statusSelect = document.getElementById('statusSelect');
    const statusForm = document.getElementById('statusForm');
    const cancelModal = document.getElementById('cancelModal');
    const cancelReason = document.getElementById('cancelReason');
    const archiveNote = document.getElementById('archiveNote');
    const confirmCancel = document.getElementById('confirmCancel');
    const cancelModalClose = document.getElementById('cancelModalClose');

    let previousStatus = statusSelect.value;

    statusSelect.addEventListener('change', function() {
        if (this.value === 'cancelled') {
            // Show confirmation modal
            cancelModal.style.display = 'flex';
        } else {
            // Submit form for other status changes
            statusForm.submit();
        }
    });

    cancelModalClose.addEventListener('click', function() {
        // Reset to previous status and close modal
        statusSelect.value = previousStatus;
        cancelModal.style.display = 'none';
        cancelReason.value = '';
    });

    confirmCancel.addEventListener('click', function() {
        // Set the archive note and submit
        archiveNote.value = cancelReason.value;
        statusForm.submit();
    });

    // Close modal on overlay click
    cancelModal.querySelector('.modal-overlay').addEventListener('click', function() {
        statusSelect.value = previousStatus;
        cancelModal.style.display = 'none';
        cancelReason.value = '';
    });

    // PCR position search and link
    var pcrSearchBtn = document.getElementById('pcrSearchBtn');
    if (pcrSearchBtn) {
        var pcrSearchInput = document.getElementById('pcrSearch');
        var pcrResults = document.getElementById('pcrResults');
        var pcrSelect = document.getElementById('pcrSelect');
        var pcrLoading = document.getElementById('pcrLoading');
        var pcrError = document.getElementById('pcrError');
        var pcrLinkBtn = document.getElementById('pcrLinkBtn');
        var pcrJobId = document.getElementById('pcrJobId');
        var pcrJobTitle = document.getElementById('pcrJobTitle');
        var pcrCompanyName = document.getElementById('pcrCompanyName');
        var positionsData = [];

        pcrSearchBtn.addEventListener('click', function() {
            var query = pcrSearchInput.value.trim();
            pcrLoading.style.display = 'block';
            pcrResults.style.display = 'none';
            pcrError.style.display = 'none';

            fetch('/pcr/api/positions?search=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    pcrLoading.style.display = 'none';
                    if (data.error) {
                        pcrError.querySelector('span').textContent = data.error;
                        pcrError.style.display = 'block';
                        return;
                    }
                    positionsData = data;
                    pcrSelect.innerHTML = '<option value="">-- Select a position (' + data.length + ' found) --</option>';
                    data.forEach(function(pos) {
                        var opt = document.createElement('option');
                        opt.value = pos.job_id;
                        opt.textContent = pos.title + ' - ' + pos.company + ' (' + pos.job_id + ')';
                        pcrSelect.appendChild(opt);
                    });
                    pcrResults.style.display = 'block';
                    pcrLinkBtn.disabled = true;
                })
                .catch(function(err) {
                    pcrLoading.style.display = 'none';
                    pcrError.querySelector('span').textContent = 'Failed to fetch positions: ' + err;
                    pcrError.style.display = 'block';
                });
        });

        pcrSelect.addEventListener('change', function() {
            var selected = this.value;
            if (!selected) {
                pcrLinkBtn.disabled = true;
                return;
            }
            var pos = positionsData.find(function(p) { return String(p.job_id) === String(selected); });
            if (pos) {
                pcrJobId.value = pos.job_id;
                pcrJobTitle.value = pos.title;
                pcrCompanyName.value = pos.company;
                pcrLinkBtn.disabled = false;
            }
        });

        pcrSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                pcrSearchBtn.click();
            }
        });
    }
})();
</script>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}
.modal-content {
    position: relative;
    background: var(--card-bg);
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}
.modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
}
.modal-header h3 {
    margin: 0;
    color: var(--danger-color);
}
.modal-body {
    padding: 1.5rem;
}
.modal-body p {
    margin: 0;
}
.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}
.btn-danger {
    background-color: var(--danger-color);
    color: white;
    border: none;
}
.btn-danger:hover {
    background-color: #dc2626;
}
</style>
{% endblock %}
