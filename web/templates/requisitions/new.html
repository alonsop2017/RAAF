{% extends "base.html" %}

{% block title %}New Requisition{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Dashboard</a> / <a href="/requisitions">Requisitions</a> / <span>New</span>
</div>

<div class="page-header">
    <h1>Create New Requisition</h1>
    <p class="subtitle">Set up a new job requisition for assessment</p>
</div>

<div class="card" style="max-width: 900px;">
    <div class="card-body">
        <form action="/requisitions/create" method="POST" enctype="multipart/form-data">
            <h3 class="mb-2">Basic Information</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="client_code">Client *</label>
                    <select id="client_code" name="client_code" class="form-select" required>
                        <option value="">Select a client...</option>
                        {% for code, name in clients %}
                        <option value="{{ code }}" {% if selected_client == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="req_id">Requisition ID *</label>
                    <input type="text" id="req_id" name="req_id" class="form-input" required
                           placeholder="e.g., REQ-2025-001-CSM">
                    <p class="form-hint">Format: REQ-YYYY-NNN-ROLE</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="title">Job Title *</label>
                    <input type="text" id="title" name="title" class="form-input" required
                           placeholder="e.g., Enterprise Customer Success Manager">
                </div>
                <div class="form-group">
                    <label class="form-label" for="department">Department</label>
                    <input type="text" id="department" name="department" class="form-input"
                           placeholder="e.g., Customer Success">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="location">Location</label>
                <input type="text" id="location" name="location" class="form-input"
                       placeholder="e.g., Toronto, ON (Hybrid)">
            </div>

            <h3 class="mt-3 mb-2">Job Description</h3>
            <div class="form-group">
                <label class="form-label" for="job_description">Upload Job Description (PDF or DOCX)</label>
                <input type="file" id="job_description" name="job_description" class="form-input"
                       accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                       onchange="handleJDUpload(this)">
                <p class="form-hint">Upload the full job description to auto-generate a tailored assessment framework.</p>
            </div>

            <h3 class="mt-3 mb-2">Assessment Framework</h3>
            <div class="form-group">
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="cursor: pointer; display: flex; align-items: flex-start; gap: 0.5rem;">
                        <input type="radio" name="framework_source" value="generate" id="fw-generate"
                               onchange="toggleFrameworkSource()" checked>
                        <div>
                            <strong>Generate from Job Description</strong>
                            <p class="form-hint" style="margin: 0.2rem 0 0;">
                                Uses AI to create a role-specific assessment framework based on the uploaded JD.
                                Requires a job description file to be uploaded above.
                            </p>
                        </div>
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: flex-start; gap: 0.5rem;">
                        <input type="radio" name="framework_source" value="template" id="fw-template"
                               onchange="toggleFrameworkSource()">
                        <div>
                            <strong>Use Existing Template</strong>
                            <p class="form-hint" style="margin: 0.2rem 0 0;">
                                Select a pre-built framework template. You can customize it later.
                            </p>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group" id="template-select-group" style="display: none;">
                <label class="form-label" for="template">Assessment Framework Template</label>
                <select id="template" name="template" class="form-select">
                    {% for t in framework_templates %}
                    <option value="{{ t.value }}">{{ t.label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="generate-info" class="alert alert-info" style="margin-top: 0.5rem;">
                <strong>AI Framework Generation:</strong> When you submit, the system will extract the job description text
                and use AI to create a tailored assessment framework with role-specific scoring criteria. This takes about 30 seconds.
            </div>

            <h3 class="mt-3 mb-2">Compensation</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="salary_min">Salary Min</label>
                    <input type="number" id="salary_min" name="salary_min" class="form-input"
                           placeholder="e.g., 80000">
                </div>
                <div class="form-group">
                    <label class="form-label" for="salary_max">Salary Max</label>
                    <input type="number" id="salary_max" name="salary_max" class="form-input"
                           placeholder="e.g., 120000">
                </div>
                <div class="form-group">
                    <label class="form-label" for="currency">Currency</label>
                    <input type="text" id="currency" name="currency" class="form-input"
                           value="CAD" placeholder="e.g., CAD, USD, EUR">
                </div>
            </div>

            <h3 class="mt-3 mb-2">Requirements</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="experience_years_min">Minimum Years of Experience</label>
                    <input type="number" id="experience_years_min" name="experience_years_min" class="form-input"
                           value="0" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="education">Education Requirement</label>
                    <input type="text" id="education" name="education" class="form-input"
                           placeholder="e.g., Bachelor's degree required">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="notes">Notes</label>
                <textarea id="notes" name="notes" class="form-textarea"
                          placeholder="Additional notes about this requisition..."></textarea>
            </div>

            <div class="action-buttons mt-3">
                <button type="submit" class="btn btn-primary btn-lg" id="create-btn">Create Requisition</button>
                <a href="/requisitions" class="btn btn-outline" id="cancel-btn">Cancel</a>
            </div>

            <!-- Progress overlay -->
            <div id="create-progress" style="display: none; margin-top: 1.5rem;">
                <div class="card" style="border: 2px solid var(--primary-color); overflow: hidden;">
                    <!-- Animated progress bar -->
                    <div style="height: 4px; background: #e2e8f0;">
                        <div id="progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary-color), #60a5fa); transition: width 0.6s ease;"></div>
                    </div>
                    <div class="card-body" style="padding: 1.25rem 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span class="progress-spinner"></span>
                                <strong id="progress-title" style="font-size: 1.05rem;">Setting up requisition...</strong>
                            </div>
                            <span id="elapsed-time" style="font-size: 0.8rem; color: var(--text-secondary); font-variant-numeric: tabular-nums;">0s</span>
                        </div>

                        <!-- Step list -->
                        <div id="progress-steps" style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 0.25rem;">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
@keyframes spin { to { transform: rotate(360deg); } }
.progress-spinner {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border: 3px solid #e2e8f0;
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
}
.step-item {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
    transition: color 0.3s;
}
.step-item.active {
    color: var(--primary-color);
    font-weight: 500;
}
.step-item.done {
    color: var(--success-color);
}
.step-icon {
    width: 1.25rem;
    height: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.85rem;
}
.step-icon.pending { color: var(--border-color); }
.step-icon.active { color: var(--primary-color); }
.step-icon.done { color: var(--success-color); }
</style>
<script>
function toggleFrameworkSource() {
    var isTemplate = document.getElementById('fw-template').checked;
    document.getElementById('template-select-group').style.display = isTemplate ? 'block' : 'none';
    document.getElementById('generate-info').style.display = isTemplate ? 'none' : 'block';
}

function handleJDUpload(input) {
    if (input.files.length > 0) {
        document.getElementById('fw-generate').checked = true;
        toggleFrameworkSource();
    }
}

document.querySelector('form').addEventListener('submit', function(e) {
    var isGenerate = document.getElementById('fw-generate').checked;
    var jdInput = document.getElementById('job_description');

    if (isGenerate && (!jdInput.files || jdInput.files.length === 0)) {
        e.preventDefault();
        alert('Please upload a job description file to generate an assessment framework, or select "Use Existing Template" instead.');
        return;
    }

    // Hide the form controls
    var btn = document.getElementById('create-btn');
    btn.disabled = true;
    btn.style.display = 'none';
    document.getElementById('cancel-btn').style.display = 'none';

    // Show progress
    document.getElementById('create-progress').style.display = 'block';

    // Scroll progress into view
    document.getElementById('create-progress').scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Define steps based on mode
    var steps;
    if (isGenerate) {
        steps = [
            { label: 'Creating requisition folder structure', duration: 1500 },
            { label: 'Uploading job description', duration: 2000 },
            { label: 'Extracting text from document', duration: 3000 },
            { label: 'Generating AI assessment framework', duration: 25000 },
            { label: 'Saving framework and configuration', duration: 5000 },
        ];
    } else {
        steps = [
            { label: 'Creating requisition folder structure', duration: 1000 },
            { label: 'Copying framework template', duration: 1500 },
            { label: 'Saving configuration', duration: 1500 },
        ];
    }

    // Render step list
    var stepsContainer = document.getElementById('progress-steps');
    steps.forEach(function(step, i) {
        var div = document.createElement('div');
        div.className = 'step-item' + (i === 0 ? ' active' : '');
        div.id = 'step-' + i;
        div.innerHTML =
            '<span class="step-icon ' + (i === 0 ? 'active' : 'pending') + '" id="step-icon-' + i + '">' +
            (i === 0 ? '&#9679;' : '&#9675;') +
            '</span>' +
            '<span>' + step.label + '</span>';
        stepsContainer.appendChild(div);
    });

    // Animate through steps
    var currentStep = 0;
    var totalDuration = steps.reduce(function(sum, s) { return sum + s.duration; }, 0);
    var elapsed = 0;

    function advanceStep() {
        if (currentStep >= steps.length) return;

        // Mark current as done
        var curEl = document.getElementById('step-' + currentStep);
        var curIcon = document.getElementById('step-icon-' + currentStep);
        curEl.className = 'step-item done';
        curIcon.className = 'step-icon done';
        curIcon.innerHTML = '&#10003;';

        currentStep++;

        if (currentStep < steps.length) {
            // Activate next step
            var nextEl = document.getElementById('step-' + currentStep);
            var nextIcon = document.getElementById('step-icon-' + currentStep);
            nextEl.className = 'step-item active';
            nextIcon.className = 'step-icon active';
            nextIcon.innerHTML = '&#9679;';

            document.getElementById('progress-title').textContent = steps[currentStep].label + '...';

            // Update progress bar
            var progressPct = Math.min(((elapsed + steps[currentStep].duration) / totalDuration) * 90, 90);
            document.getElementById('progress-bar').style.width = progressPct + '%';

            setTimeout(advanceStep, steps[currentStep].duration);
        } else {
            // All steps done - waiting for server redirect
            document.getElementById('progress-title').textContent = 'Finalizing...';
            document.getElementById('progress-bar').style.width = '95%';
        }
    }

    // Start advancing after first step duration
    document.getElementById('progress-title').textContent = steps[0].label + '...';
    document.getElementById('progress-bar').style.width = '5%';
    setTimeout(advanceStep, steps[0].duration);

    // Elapsed time counter
    var startTime = Date.now();
    var timerEl = document.getElementById('elapsed-time');
    setInterval(function() {
        var secs = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = secs + 's';
        elapsed = (Date.now() - startTime);
    }, 1000);
});
</script>
{% endblock %}
