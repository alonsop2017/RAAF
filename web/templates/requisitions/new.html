{% extends "base.html" %}

{% block title %}New Requisition{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Dashboard</a> / <a href="/requisitions">Requisitions</a> / <span>New</span>
</div>

<div class="page-header">
    <h1>Create New Requisition</h1>
    <p class="subtitle">Set up a new job requisition for assessment</p>
</div>

<div class="card" style="max-width: 900px;">
    <div class="card-body">
        <form action="/requisitions/create" method="POST" enctype="multipart/form-data">
            <h3 class="mb-2">Basic Information</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="client_code">Client *</label>
                    <select id="client_code" name="client_code" class="form-select" required>
                        <option value="">Select a client...</option>
                        {% for code, name in clients %}
                        <option value="{{ code }}" {% if selected_client == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="req_id">Requisition ID *</label>
                    <input type="text" id="req_id" name="req_id" class="form-input" required
                           placeholder="e.g., REQ-2025-001-CSM">
                    <p class="form-hint">Format: REQ-YYYY-NNN-ROLE</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="title">Job Title *</label>
                    <input type="text" id="title" name="title" class="form-input" required
                           placeholder="e.g., Enterprise Customer Success Manager">
                </div>
                <div class="form-group">
                    <label class="form-label" for="department">Department</label>
                    <input type="text" id="department" name="department" class="form-input"
                           placeholder="e.g., Customer Success">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="location">Location</label>
                <input type="text" id="location" name="location" class="form-input"
                       placeholder="e.g., Toronto, ON (Hybrid)">
            </div>

            <h3 class="mt-3 mb-2">Job Description</h3>
            <div class="form-group">
                <label class="form-label" for="job_description">Upload Job Description (PDF or DOCX)</label>
                <input type="file" id="job_description" name="job_description" class="form-input"
                       accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                       onchange="handleJDUpload(this)">
                <p class="form-hint">Upload the full job description to auto-generate a tailored assessment framework.</p>
            </div>

            <h3 class="mt-3 mb-2">Assessment Framework</h3>
            <div class="form-group">
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="cursor: pointer; display: flex; align-items: flex-start; gap: 0.5rem;">
                        <input type="radio" name="framework_source" value="generate" id="fw-generate"
                               onchange="toggleFrameworkSource()" checked>
                        <div>
                            <strong>Generate from Job Description</strong>
                            <p class="form-hint" style="margin: 0.2rem 0 0;">
                                Uses AI to create a role-specific assessment framework based on the uploaded JD.
                                Requires a job description file to be uploaded above.
                            </p>
                        </div>
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: flex-start; gap: 0.5rem;">
                        <input type="radio" name="framework_source" value="template" id="fw-template"
                               onchange="toggleFrameworkSource()">
                        <div>
                            <strong>Use Existing Template</strong>
                            <p class="form-hint" style="margin: 0.2rem 0 0;">
                                Select a pre-built framework template. You can customize it later.
                            </p>
                        </div>
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: flex-start; gap: 0.5rem;">
                        <input type="radio" name="framework_source" value="generate" id="fw-pcr"
                               onchange="toggleFrameworkSource()">
                        <div>
                            <strong>Pull from PCR Position</strong>
                            <p class="form-hint" style="margin: 0.2rem 0 0;">
                                Search for a PCR position, pull its job description, and generate an AI assessment framework.
                            </p>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group" id="template-select-group" style="display: none;">
                <label class="form-label" for="template">Assessment Framework Template</label>
                <select id="template" name="template" class="form-select">
                    {% for t in framework_templates %}
                    <option value="{{ t.value }}">{{ t.label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- PCR Position Search (shown when "Pull from PCR" is selected) -->
            <div id="pcr-position-group" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Search PCR Positions</label>
                    <div style="display:flex; gap:0.5rem;">
                        <input type="text" id="pcrNewSearch" class="form-input" style="flex:1;" placeholder="Company name...">
                        <button type="button" id="pcrNewSearchBtn" class="btn btn-sm btn-primary">Search</button>
                    </div>
                </div>
                <div id="pcrNewLoading" style="display:none;" class="mt-1">
                    <span class="text-muted">Searching PCR positions (this may take a few seconds)...</span>
                </div>
                <div id="pcrNewError" style="display:none;" class="mt-1 alert alert-danger">
                    <span></span>
                </div>
                <div id="pcrNewResults" style="display:none;" class="mt-1">
                    <div class="form-group">
                        <label class="form-label">Select a Position</label>
                        <div id="pcrNewList" style="max-height:250px; overflow-y:auto; border:1px solid var(--border-color); border-radius:6px; padding:0.5rem;"></div>
                    </div>
                </div>
                <div id="pcrSelectedInfo" style="display:none;" class="mt-1 alert alert-info">
                    <strong>Selected:</strong> <span id="pcrSelectedName"></span>
                </div>
                <input type="hidden" name="pcr_job_id" id="pcr_job_id" value="">
            </div>

            <div id="generate-info" class="alert alert-info" style="margin-top: 0.5rem;">
                <strong>AI Framework Generation:</strong> When you submit, the system will extract the job description text
                and use AI to create a tailored assessment framework with role-specific scoring criteria. This takes about 30 seconds.
            </div>

            <h3 class="mt-3 mb-2">Compensation</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="salary_min">Salary Min</label>
                    <input type="number" id="salary_min" name="salary_min" class="form-input"
                           placeholder="e.g., 80000">
                </div>
                <div class="form-group">
                    <label class="form-label" for="salary_max">Salary Max</label>
                    <input type="number" id="salary_max" name="salary_max" class="form-input"
                           placeholder="e.g., 120000">
                </div>
                <div class="form-group">
                    <label class="form-label" for="currency">Currency</label>
                    <input type="text" id="currency" name="currency" class="form-input"
                           value="CAD" placeholder="e.g., CAD, USD, EUR">
                </div>
            </div>

            <h3 class="mt-3 mb-2">Requirements</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="experience_years_min">Minimum Years of Experience</label>
                    <input type="number" id="experience_years_min" name="experience_years_min" class="form-input"
                           value="0" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="education">Education Requirement</label>
                    <input type="text" id="education" name="education" class="form-input"
                           placeholder="e.g., Bachelor's degree required">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="notes">Notes</label>
                <textarea id="notes" name="notes" class="form-textarea"
                          placeholder="Additional notes about this requisition..."></textarea>
            </div>

            <div class="action-buttons mt-3">
                <button type="submit" class="btn btn-primary btn-lg" id="create-btn">Create Requisition</button>
                <a href="/requisitions" class="btn btn-outline" id="cancel-btn">Cancel</a>
            </div>

            <!-- Progress overlay -->
            <div id="create-progress" style="display: none; margin-top: 1.5rem;">
                <div class="card" style="border: 2px solid var(--primary-color); overflow: hidden;">
                    <!-- Animated progress bar -->
                    <div style="height: 4px; background: #e2e8f0;">
                        <div id="progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary-color), #60a5fa); transition: width 0.6s ease;"></div>
                    </div>
                    <div class="card-body" style="padding: 1.25rem 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span class="progress-spinner"></span>
                                <strong id="progress-title" style="font-size: 1.05rem;">Setting up requisition...</strong>
                            </div>
                            <span id="elapsed-time" style="font-size: 0.8rem; color: var(--text-secondary); font-variant-numeric: tabular-nums;">0s</span>
                        </div>

                        <!-- Step list -->
                        <div id="progress-steps" style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 0.25rem;">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
@keyframes spin { to { transform: rotate(360deg); } }
.progress-spinner {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border: 3px solid #e2e8f0;
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
}
.step-item {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
    transition: color 0.3s;
}
.step-item.active {
    color: var(--primary-color);
    font-weight: 500;
}
.step-item.done {
    color: var(--success-color);
}
.step-icon {
    width: 1.25rem;
    height: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 0.85rem;
}
.step-icon.pending { color: var(--border-color); }
.step-icon.active { color: var(--primary-color); }
.step-icon.done { color: var(--success-color); }
</style>
<script>
function toggleFrameworkSource() {
    var isTemplate = document.getElementById('fw-template').checked;
    var isGenerate = document.getElementById('fw-generate').checked;
    var isPCR = document.getElementById('fw-pcr').checked;
    document.getElementById('template-select-group').style.display = isTemplate ? 'block' : 'none';
    document.getElementById('pcr-position-group').style.display = isPCR ? 'block' : 'none';
    document.getElementById('generate-info').style.display = (isGenerate || isPCR) ? 'block' : 'none';
}

function handleJDUpload(input) {
    if (input.files.length > 0) {
        document.getElementById('fw-generate').checked = true;
        toggleFrameworkSource();
    }
}

// PCR position search for new requisition form
(function() {
    var searchBtn = document.getElementById('pcrNewSearchBtn');
    var searchInput = document.getElementById('pcrNewSearch');
    var loading = document.getElementById('pcrNewLoading');
    var errorEl = document.getElementById('pcrNewError');
    var resultsEl = document.getElementById('pcrNewResults');
    var listEl = document.getElementById('pcrNewList');
    var selectedInfo = document.getElementById('pcrSelectedInfo');
    var selectedName = document.getElementById('pcrSelectedName');
    var hiddenInput = document.getElementById('pcr_job_id');

    searchBtn.addEventListener('click', function() {
        var query = searchInput.value.trim();
        if (!query) return;
        loading.style.display = 'block';
        resultsEl.style.display = 'none';
        errorEl.style.display = 'none';
        searchBtn.disabled = true;
        searchBtn.textContent = 'Searching...';

        fetch('/pcr/api/positions?search=' + encodeURIComponent(query))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
                if (data.error) {
                    errorEl.querySelector('span').textContent = data.error;
                    errorEl.style.display = 'block';
                    return;
                }
                listEl.innerHTML = '';
                if (data.length === 0) {
                    listEl.innerHTML = '<span class="text-muted">No positions found.</span>';
                    resultsEl.style.display = 'block';
                    return;
                }
                data.forEach(function(pos) {
                    var row = document.createElement('label');
                    row.style.cssText = 'display:flex; align-items:center; gap:0.5rem; padding:0.4rem 0.25rem; border-bottom:1px solid var(--border-color); cursor:pointer;';
                    row.innerHTML =
                        '<input type="radio" name="pcr_position_radio" value="' + pos.job_id + '" ' +
                        'data-title="' + (pos.title || '').replace(/"/g, '&quot;') + '" ' +
                        'data-location="' + (pos.location || '').replace(/"/g, '&quot;') + '" ' +
                        'data-company="' + (pos.company || '').replace(/"/g, '&quot;') + '">' +
                        '<span style="flex:1;">' +
                        '<span style="display:inline-block; background:var(--accent-color,#0d6efd); color:#fff; font-size:0.75rem; font-weight:600; border-radius:3px; padding:1px 6px; margin-right:6px; vertical-align:middle; font-family:monospace;">#' + pos.job_id + '</span>' +
                        '<strong>' + (pos.title || 'Untitled') + '</strong>' +
                        '<br><span class="text-muted" style="font-size:0.85rem;">' + (pos.company || '') +
                        (pos.location ? ' &middot; ' + pos.location : '') +
                        ' &middot; ' + (pos.status || 'Open') + '</span></span>';
                    listEl.appendChild(row);
                });
                resultsEl.style.display = 'block';

                // Handle radio selection
                listEl.querySelectorAll('input[name="pcr_position_radio"]').forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        hiddenInput.value = this.value;
                        var posTitle = this.getAttribute('data-title');
                        var posLocation = this.getAttribute('data-location');
                        var posCompany = this.getAttribute('data-company');
                        selectedName.textContent = posTitle + ' (' + posCompany + ')';
                        selectedInfo.style.display = 'block';

                        // Auto-fill form fields if empty
                        var titleInput = document.getElementById('title');
                        var locationInput = document.getElementById('location');
                        if (titleInput && !titleInput.value) titleInput.value = posTitle;
                        if (locationInput && !locationInput.value) locationInput.value = posLocation;
                    });
                });
            })
            .catch(function(err) {
                loading.style.display = 'none';
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
                errorEl.querySelector('span').textContent = 'Failed to fetch positions: ' + err;
                errorEl.style.display = 'block';
            });
    });

    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchBtn.click();
        }
    });
})();

document.querySelector('form').addEventListener('submit', function(e) {
    var isGenerate = document.getElementById('fw-generate').checked;
    var isPCR = document.getElementById('fw-pcr').checked;
    var jdInput = document.getElementById('job_description');
    var pcrJobId = document.getElementById('pcr_job_id').value;

    if (isGenerate && (!jdInput.files || jdInput.files.length === 0)) {
        e.preventDefault();
        alert('Please upload a job description file to generate an assessment framework, or select "Use Existing Template" instead.');
        return;
    }

    if (isPCR && !pcrJobId) {
        e.preventDefault();
        alert('Please search and select a PCR position to pull the job description from.');
        return;
    }

    // Hide the form controls
    var btn = document.getElementById('create-btn');
    btn.disabled = true;
    btn.style.display = 'none';
    document.getElementById('cancel-btn').style.display = 'none';

    // Show progress
    document.getElementById('create-progress').style.display = 'block';

    // Scroll progress into view
    document.getElementById('create-progress').scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Define steps based on mode
    var steps;
    if (isPCR) {
        steps = [
            { label: 'Creating requisition folder structure', duration: 1500 },
            { label: 'Fetching job description from PCR', duration: 4000 },
            { label: 'Generating AI assessment framework', duration: 25000 },
            { label: 'Saving framework and configuration', duration: 5000 },
        ];
    } else if (isGenerate) {
        steps = [
            { label: 'Creating requisition folder structure', duration: 1500 },
            { label: 'Uploading job description', duration: 2000 },
            { label: 'Extracting text from document', duration: 3000 },
            { label: 'Generating AI assessment framework', duration: 25000 },
            { label: 'Saving framework and configuration', duration: 5000 },
        ];
    } else {
        steps = [
            { label: 'Creating requisition folder structure', duration: 1000 },
            { label: 'Copying framework template', duration: 1500 },
            { label: 'Saving configuration', duration: 1500 },
        ];
    }

    // Render step list
    var stepsContainer = document.getElementById('progress-steps');
    steps.forEach(function(step, i) {
        var div = document.createElement('div');
        div.className = 'step-item' + (i === 0 ? ' active' : '');
        div.id = 'step-' + i;
        div.innerHTML =
            '<span class="step-icon ' + (i === 0 ? 'active' : 'pending') + '" id="step-icon-' + i + '">' +
            (i === 0 ? '&#9679;' : '&#9675;') +
            '</span>' +
            '<span>' + step.label + '</span>';
        stepsContainer.appendChild(div);
    });

    // Animate through steps
    var currentStep = 0;
    var totalDuration = steps.reduce(function(sum, s) { return sum + s.duration; }, 0);
    var elapsed = 0;

    function advanceStep() {
        if (currentStep >= steps.length) return;

        // Mark current as done
        var curEl = document.getElementById('step-' + currentStep);
        var curIcon = document.getElementById('step-icon-' + currentStep);
        curEl.className = 'step-item done';
        curIcon.className = 'step-icon done';
        curIcon.innerHTML = '&#10003;';

        currentStep++;

        if (currentStep < steps.length) {
            // Activate next step
            var nextEl = document.getElementById('step-' + currentStep);
            var nextIcon = document.getElementById('step-icon-' + currentStep);
            nextEl.className = 'step-item active';
            nextIcon.className = 'step-icon active';
            nextIcon.innerHTML = '&#9679;';

            document.getElementById('progress-title').textContent = steps[currentStep].label + '...';

            // Update progress bar
            var progressPct = Math.min(((elapsed + steps[currentStep].duration) / totalDuration) * 90, 90);
            document.getElementById('progress-bar').style.width = progressPct + '%';

            setTimeout(advanceStep, steps[currentStep].duration);
        } else {
            // All steps done - waiting for server redirect
            document.getElementById('progress-title').textContent = 'Finalizing...';
            document.getElementById('progress-bar').style.width = '95%';
        }
    }

    // Start advancing after first step duration
    document.getElementById('progress-title').textContent = steps[0].label + '...';
    document.getElementById('progress-bar').style.width = '5%';
    setTimeout(advanceStep, steps[0].duration);

    // Elapsed time counter
    var startTime = Date.now();
    var timerEl = document.getElementById('elapsed-time');
    setInterval(function() {
        var secs = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = secs + 's';
        elapsed = (Date.now() - startTime);
    }, 1000);
});
</script>
{% endblock %}
